#!/usr/bin/env bash

DATA_DIR="pokemon_data"
LOG_FILE="$DATA_DIR/error.log"

mkdir -p "$DATA_DIR"
: > "$LOG_FILE"

POKEMONS=("bulbasaur" "ivysaur" "venusaur" "charmander" "charmeleon")
PIDS=()

fetch_pokemon() {
  local name=$1
  local url="https://pokeapi.co/api/v2/pokemon/$name"
  local output_file="$DATA_DIR/$name.json"

  echo "Fetching $name in PID $$..."
  curl -s --fail "$url" -o "$output_file"
  if [ $? -eq 0 ] && [ -s "$output_file" ]; then
    echo "✅ $name fetched successfully (PID $$)"
  else
    echo "❌ Failed to fetch $name (PID $$)" | tee -a "$LOG_FILE"
    rm -f "$output_file" 2>/dev/null
  fi
}

# Launch background jobs and store PIDs
for name in "${POKEMONS[@]}"; do
  fetch_pokemon "$name" &
  PIDS+=($!)
done

# Optionally check and kill zombie/stuck processes (simulate kill usage)
for pid in "${PIDS[@]}"; do
  if kill -0 "$pid" 2>/dev/null; then
    wait "$pid"
  fi
done

echo ""
echo "🎉 All fetch operations completed!"
